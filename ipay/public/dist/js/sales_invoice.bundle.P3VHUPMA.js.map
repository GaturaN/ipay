{
  "version": 3,
  "sources": ["../../../../../apps/ipay/ipay/public/js/sales_invoice.js"],
  "sourcesContent": ["frappe.ui.form.on('Sales Invoice', {\n   refresh: function (frm) {\n      const submitted = frm.doc.docstatus === 1;\n      const status = frm.doc.status;\n      const bal = frm.doc.outstanding_amount > 0;\n\n      if (submitted && bal && status !== 'Paid') {\n         frm.add_custom_button(__('iPay Request'), () => {\n            const customer = frm.doc.customer;\n            const salesInvoice = frm.doc.name;\n\n            // Check if an iPay Request already exists\n            frappe.call({\n               method: 'frappe.client.get_list',\n               args: {\n                  doctype: 'iPay Request',\n                  filters: { sales_invoice: salesInvoice, docstatus: 1 },\n                  fields: ['name'],\n                  limit_page_length: 1,\n               },\n               callback: function (response) {\n                  if (response.message.length > 0) {\n                     const ipay_request_name = response.message[0].name;\n                     const ipay_request_url = `/app/ipay-request/${ipay_request_name}`;\n\n                     frappe.msgprint({\n                        title: __('iPay Request Exists'),\n                        message: __(\n                           `An iPay Request for this Sales Invoice already exists. \n                          <a href=\"${ipay_request_url}\" target=\"_blank\" style=\"font-weight:bold; color:#007bff;\">Click here to view</a>`\n                        ),\n                        indicator: 'green',\n                     });\n\n                     return;\n                  }\n\n                  // If no existing request, create a new iPay Request\n                  frappe.call({\n                     method: 'frappe.client.insert',\n                     args: {\n                        doc: {\n                           doctype: 'iPay Request',\n                           customer: customer,\n                           sales_invoice: salesInvoice,\n                           docstatus: 1,\n                        },\n                     },\n                     freeze: true,\n                     callback: function (r) {\n                        if (!r.exc) {\n                           const ipay_request_name = r.message.name;\n\n                           frappe.show_alert({\n                              message: __('iPay Request Created successfully'),\n                              indicator: 'green',\n                           });\n\n                           frappe.confirm(__('Do you want to be redirected to the newly created iPay Request?'), function () {\n                              frappe.set_route('Form', 'iPay Request', ipay_request_name);\n                           });\n\n                           // Store iPay Request name in frm for later use\n                           frm.doc.ipay_request = ipay_request_name;\n                        } else {\n                           frappe.msgprint(__('Failed to create iPay Request'));\n                        }\n                     },\n                  });\n               },\n            });\n         })\n            .addClass('btn-warning')\n            .removeClass('btn-default');\n      }\n   },\n\n   on_submit: function (frm) {\n      frappe.call({\n         method: 'ipay.ipay.main.utils.cod_create_request.create_request',\n         args: { inv: frm.doc.name },\n         callback: function (r) {\n            if (!r.message) {\n               frappe.show_alert({\n                  message: __('No response received from the server.'),\n                  indicator: 'red',\n               });\n               return;\n            }\n\n            const { status, message: ipay_request_name } = r.message;\n\n            if (status === 'success') {\n               frappe.show_alert({\n                  message: __(`iPay Request <a href=\"/app/ipay-request/${ipay_request_name}\" target=\"_blank\" style=\"font-weight:bold; color:white; text-decoration:underline;\">${ipay_request_name}</a> created successfully.`),\n                  indicator: 'green',\n               });\n\n               frappe.call({\n                  method: 'ipay.ipay.main.utils.driver.update_driver',\n                  args: { request_name: ipay_request_name },\n                  callback: function (r) {\n                     if (r.message && r.message.status === 'success') {\n                        frappe.show_alert({\n                           message: __('Driver updated: ' + r.message.driver_name),\n                           indicator: 'blue',\n                        });\n                     }\n                  },\n               });\n            }\n         },\n      });\n   },\n});\n"],
  "mappings": "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",
  "names": ["r"]
}
